---
title: "Pima Indians Diabetes 数据分析与 GLM 模型训练"
author: ""
date: "`r Sys.Date()`"
output: html_document
---
```

## 1. 数据加载与初步探索



```{r chunk1}
# 若尚未安装 mlbench 包，请先安装

library(mlbench)


# 加载 Pima Indians Diabetes 数据集
data("PimaIndiansDiabetes")

# 将数据存储到 df 对象中
df <- PimaIndiansDiabetes

# 查看数据结构及前几行
str(df)
head(df)
```



> **说明**
> 数据集包含 768 行和 9 列，主要属性包括：
>
> * **pregnant**：怀孕次数
> * **glucose**：血浆葡萄糖浓度
> * **pressure**：舒张压（mm Hg）
> * **triceps**：三头肌皮褶厚度（mm）
> * **insulin**：2 小时血清胰岛素（mu U/ml）
> * **mass**：BMI（身体质量指数）
> * **pedigree**：糖尿病家族史函数
> * **age**：年龄
> * **diabetes**：目标变量，factor 类别（“pos” 表示患糖尿病， “neg” 表示未患病）

---

## 2. 数据清洗和预处理

### 2.1 检查缺失值和异常值

```{r chunk2}
# 查看每个变量的基本统计信息
summary(df)

# 检查缺失值的数量
sapply(df, function(x) sum(is.na(x)))
```

> **说明**
> Pima Indians Diabetes 数据集虽然没有显式的 NA，但其中部分变量（如 insulin、triceps 等）常常以 0 表示缺失或异常值。这里你可以视情况采用替换 0 值为 NA，再对缺失值进行后续处理。

### 2.2 处理异常值（可选）

下面示例中我们对 glucose 这一变量进行简单检查，实际上你可以根据研究需求对多个变量进行处理。

```{r handle-zeros}
# 查看 glucose 中 0 值数量
sum(df$glucose == 0)

# 如果认为 0 为异常（不可能为 0），则将 0 替换为 NA
df$glucose <- ifelse(df$glucose == 0, NA, df$glucose)

# 查看更新后的缺失值情况
table(is.na(df$glucose))
```

### 2.3 数据预处理

```{r preprocessing}
# 对于目标变量 diabetes，将其确认转为 factor（若尚未是 factor）
df$diabetes <- as.factor(df$diabetes)

# 若需要，对其他变量进行标准化或归一化（这里简单示例，后面模型内会自动处理）
# 注：实际项目中，你可能需要对连续变量执行归一化或标准化步骤
```

---

## 3. 属性交叉分析

### 3.1 数值变量分布

```{r univariate-plots, fig.width=7, fig.height=5}
library(ggplot2)

# 绘制 age 与 glucose 的直方图分布
ggplot(df, aes(x = age)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "black") +
  labs(title = "Age 分布", x = "年龄", y = "频数")

ggplot(df, aes(x = glucose)) +
  geom_histogram(bins = 30, fill = "lightgreen", color = "black") +
  labs(title = "Glucose 分布", x = "血浆葡萄糖浓度", y = "频数")
```

### 3.2 分类变量对目标变量的影响

```{r categorical-analysis}
# 分析怀孕次数对糖尿病的影响，可以将 pregnant 离散化
table(df$pregnant)

# 绘制怀孕次数与糖尿病状态的关系
ggplot(df, aes(x = as.factor(pregnant), fill = diabetes)) +
  geom_bar(position = "fill") +
  labs(title = "不同怀孕次数患者糖尿病比例", x = "怀孕次数", y = "比例", fill = "糖尿病状态")
```

### 3.3 属性交叉分析：散点图探究连续变量关系

```{r scatter-analysis}
# 散点图：age vs. glucose，不同糖尿病状态
ggplot(df, aes(x = age, y = glucose, color = diabetes)) +
  geom_point() +
  labs(title = "年龄和血浆葡萄糖浓度关系", x = "年龄", y = "血浆葡萄糖浓度", color = "糖尿病状态")
```

---

## 4. GLM 模型训练

本例中我们使用逻辑回归来建模（目标变量为二分类变量 diabetes）

### 4.1 分割数据集为训练集与测试集

```{r train-test-split}
# 若尚未安装 caret 包，可先安装
if(!require(caret)){
  install.packages("caret")
  library(caret)
}

set.seed(123)
train_index <- createDataPartition(df$diabetes, p = 0.7, list = FALSE)
train_data <- df[train_index, ]
test_data <- df[-train_index, ]
```

### 4.2 模型训练：逻辑回归（GLM, family = binomial）

```{r glm-training}
# 训练逻辑回归模型（使用所有变量作为解释变量）
glm_model <- glm(diabetes ~ ., data = train_data, family = "binomial")

# 查看模型摘要
summary(glm_model)
```

### 4.3 模型预测与评估

```{r glm-prediction}
# 在测试集上预测概率
pred_prob <- predict(glm_model, newdata = test_data, type = "response")

# 根据概率 0.5 分界点转换为类别
pred_class <- ifelse(pred_prob > 0.5, "pos", "neg")
pred_class <- factor(pred_class, levels = levels(test_data$diabetes))

# 构造混淆矩阵
conf_matrix <- table(Predicted = pred_class, Actual = test_data$diabetes)
print(conf_matrix)

# 计算准确率
accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
cat("准确率 =", accuracy, "\n")
```

---

## 5. 总结

* **数据读取**：成功加载 Pima Indians Diabetes 数据集。
* **数据清洗预处理**：检查缺失值、处理异常值，并转换数据类型。
* **属性交叉分析**：通过直方图、分组条形图和散点图分析了各变量分布及其与糖尿病状态的关系。
* **GLM 模型**：利用逻辑回归进行了分类建模，并在测试集上评估了模型的基本表现。

---

这个 R Markdown 示例为你从头到尾建立了一个完整的数据分析与预测流程。运行后你可以获得数据探索图、模型训练摘要与评价指标。如果需要进一步调整或深入分析，请根据实际情况调整代码。
